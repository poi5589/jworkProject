<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="mailMapper">
	
	<resultMap type="Mail" id="mailResultMap">
		<id column="mail_no" property="mailNo" />
		<result column="sender_no" property="senderNo" />
		<result column="sender" property="sender" />
		<result column="receiver" property="receiver" />
		<result column="mail_title" property="mailTitle" />
		<result column="mail_content" property="mailContent" />
		<result column="register_date" property="registerDate" />
		<result column="send" property="send" />
		
		<result column="mailbox_no" property="mailBoxNo" />
		<result column="emp_no" property="empNo" />
		<result column="emp_name" property="empName" />
		<result column="read" property="read" />
		<result column="read_date" property="readDate" />
		<result column="important" property="important" />
		<result column="type" property="type" />
		<result column="status" property="status" />
		
		<result column="mailbox_name" property="mailBoxName" />
	</resultMap>
	
	
	
	<select id="selectListCount" resultType="_int">
		select
		       count(*)
		  from mail m 
		  join mail_detail d on (m.mail_no = d.mail_no)
		 where 
		 	<choose>
			 	<when test='mailCategory == "휴지통"'>
			 			status = 'N' 
			 		and emp_no = #{empNo}
			 	</when>
			 	<otherwise>
			 		status = 'Y'
			 	</otherwise>
		    </choose>
		    <if test='mailCategory == "받은메일함"'>
		    	and type = 'R' 
		    	and emp_no = #{empNo}
		    	and mailbox_no is null 
		    	and send = 'Y'
		    </if>
		    <if test='mailCategory == "보낸메일함"'>
		    	and type = 'R' 
		    	and sender_no = #{empNo} 
		    	and mailbox_no is null 
		    	and send = 'Y'
		    </if>
		    <if test='mailCategory == "중요"'>
		    	and important = 'Y' 
		    	and emp_no = #{empNo}
		    </if>
		    <if test='mailCategory == "임시보관함"'>
		    	and send = 'N' 
		    	and emp_no = #{empNo}
		    </if>
		    <if test='mailCategory == "사용자메일함"'>
		    	and send = 'Y' 
		    	and mailbox_no = #{mailBoxNo}
		    </if>
		   
	</select>
	
	<select id="selectUnReadListCount" resultType="_int">
		select
		       count(*)
		  from mail m 
		  join mail_detail d on (m.mail_no = d.mail_no)
		 where 
		 	<choose>
			 	<when test='mailCategory == "휴지통"'>
			 			status = 'N' 
			 		and emp_no = #{empNo}
			 	</when>
			 	<otherwise>
			 		status = 'Y'
			 	</otherwise>
		    </choose>
		    <if test='mailCategory == "받은메일함"'>
		    	and type = 'R' 
		    	and emp_no = #{empNo}
		    	and mailbox_no is null 
		    	and send = 'Y'
		    </if>
		    <if test='mailCategory == "보낸메일함"'>
		    	and type = 'R' 
		    	and sender_no = #{empNo} 
		    	and mailbox_no is null 
		    	and send = 'Y'
		    </if>
		    <if test='mailCategory == "중요"'>
		    	and important = 'Y' 
		    	and emp_no = #{empNo}
		    </if>
		    <if test='mailCategory == "임시보관함"'>
		    	and send = 'N' 
		    	and emp_no = #{empNo}
		    </if>
		    <if test='mailCategory == "사용자메일함"'>
		    	and send = 'Y' 
		    	and mailbox_no = #{mailBoxNo}
		    </if>
		    and read = 'N'
	</select>
	
	<select id="selectMailList" resultMap="mailResultMap">
		select
		       m.mail_no
		     , d.important
		     , d.read
		     , m.sender
		     , d.emp_name
		     , m.mail_title
		     , to_char(m.register_date, 'YYYY.MM.DD HH24:MI:SS') "register_date"
		     , (select count(*) from mail_at where mail_no = m.mail_no) "attachment"
     		 , d.read_date
		  from mail m 
		  join mail_detail d on (m.mail_no = d.mail_no)
		 where 
		 	<choose>
			 	<when test='mailCategory == "휴지통"'>
			 			status = 'N' 
			 		and emp_no = #{empNo}
			 	</when>
			 	<otherwise>
			 		status = 'Y'
			 	</otherwise>
		    </choose>
		    <if test='mailCategory == "받은메일함"'>
		    	and type = 'R' 
		    	and emp_no = #{empNo}
		    	and mailbox_no is null 
		    	and send = 'Y'
		    </if>
		    <if test='mailCategory == "보낸메일함"'>
		    	and type = 'R' 
		    	and sender_no = #{empNo} 
		    	and mailbox_no is null 
		    	and send = 'Y'
		    </if>
		    <if test='mailCategory == "중요"'>
		    	and important = 'Y' 
		    	and emp_no = #{empNo}
		    </if>
		    <if test='mailCategory == "임시보관함"'>
		    	and send = 'N' 
		    	and emp_no = #{empNo}
		    </if>
		    <if test='mailCategory == "사용자메일함"'>
		    	and send = 'Y' 
		    	and mailbox_no = #{mailBoxNo}
		    </if>
		 order
		    by register_date desc
	</select>
	
	<select id="selectMailBoxList" resultMap="mailResultMap">
		select
		       mailbox_no
		     , mailbox_name
		  from mailbox
		 where emp_no = #{empNo}
		 order
		    by enroll_date
	</select>
	
	<update id="updateMailBox">
		update
		       mailbox
		   set mailbox_name = #{mailBoxName}
		 where mailbox_no = #{mailBoxNo}
	</update>
	
	<insert id="insertMailBox">
		insert
		  into mailbox
		     (
		       mailbox_no
		     , mailbox_name
		     , enroll_date
		     , emp_no
		     )
		values
		     (
		       seq_mbno.nextval
		     , #{mailBoxName}
		     , sysdate
		     , #{empNo}
		     )
	</insert>
	
	<select id="selectMailBox" resultMap="mailResultMap">
		select 
		       mailbox_no
		     , mailbox_name
		  from mailbox
		 where mailbox_name = #{mailBoxName}
		   and emp_no = #{empNo}
	</select>
	
	<update id="updateMailsWithMailBox">
		update
		       mail_detail
		   set status = 'N'
		 where mailbox_no = #{mailBoxNo}
	</update>
	
	<delete id="deleteMailBox">
		delete
		  from mailbox
		 where mailbox_no = #{mailBoxNo}
	</delete>
	
	<update id="moveMail">
		update
			   mail_detail
		   set status = #{status}
		   <choose>
			 	<when test="mailBoxNo == 0">
			 		, mailbox_no = null
			 	</when>
			 	<otherwise>
			 		, mailbox_no = #{ mailBoxNo }
			 	</otherwise>
		   </choose>
		   <if test='type == "R" or type == "S"'>
		 	, type = #{type}
		   </if>
		 where mail_no = #{ mailNo }
		   and emp_no = #{ empNo }
	</update>
	
	<update id="updateImportant">
		update
		       mail_detail
		   set important = #{important}
		 where mail_no = #{mailNo}
		   and emp_no = #{empNo}
	</update>
	
</mapper>
